# =============================================================================
# Prometheus â€” Scrape Configuration
# Collects metrics from all Superbox services.
# =============================================================================

global:
  scrape_interval: 15s
  evaluation_interval: 15s
  scrape_timeout: 10s
  external_labels:
    monitor: superbox
    environment: production

# Alertmanager configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - alertmanager:9093

# Load alerting rules
rule_files:
  - /etc/prometheus/rules/*.yml

# ---------------------------------------------------------------------------
# Scrape jobs
# ---------------------------------------------------------------------------
scrape_configs:

  # Prometheus self-monitoring
  - job_name: prometheus
    static_configs:
      - targets: [localhost:9090]
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: prometheus

  # Traefik metrics
  - job_name: traefik
    static_configs:
      - targets: [traefik:8899]
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: traefik

  # Host metrics (node-exporter)
  - job_name: node-exporter
    static_configs:
      - targets: [node-exporter:9100]
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: superbox-host

  # Container metrics (cAdvisor)
  - job_name: cadvisor
    static_configs:
      - targets: [cadvisor:8080]
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: cadvisor
    metric_relabel_configs:
      # Drop high-cardinality container metrics we don't need
      - source_labels: [container_label_com_docker_compose_service]
        action: keep
        regex: .+

  # Grafana metrics
  - job_name: grafana
    static_configs:
      - targets: [grafana:3000]
    metrics_path: /metrics
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: grafana

  # Authentik metrics
  - job_name: authentik
    static_configs:
      - targets: [authentik-server:9300]
    metrics_path: /metrics
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: authentik

  # PostgreSQL metrics (via authentik-db direct)
  - job_name: postgres
    static_configs:
      - targets: [authentik-db:5432]
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: authentik-db
