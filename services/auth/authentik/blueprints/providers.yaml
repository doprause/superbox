# =============================================================================
# Authentik Blueprint — OAuth2/OIDC and Forward Auth Providers
# Each service that integrates with SSO gets a provider defined here.
# Applied automatically on startup.
# =============================================================================
version: 1
metadata:
  name: Superbox Providers
  labels:
    blueprints.goauthentik.io/instantiate: "true"

entries:
  # ---------------------------------------------------------------------------
  # Grafana — OAuth2/OIDC provider
  # ---------------------------------------------------------------------------
  - model: authentik_providers_oauth2.oauth2provider
    state: present
    identifiers:
      name: Grafana Provider
    attrs:
      name: Grafana Provider
      authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
      client_type: confidential
      client_id: grafana
      client_secret: !Env "GRAFANA_OAUTH_SECRET"
      invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]
      redirect_uris:
        - url: !Format ["https://grafana.%s/login/generic_oauth", !Env "DOMAIN"]
          matching_mode: strict
      access_token_validity: hours=1
      refresh_token_validity: days=30
      property_mappings:
        - !Find [authentik_providers_oauth2.scopemapping, [scope_name, openid]]
        - !Find [authentik_providers_oauth2.scopemapping, [scope_name, email]]
        - !Find [authentik_providers_oauth2.scopemapping, [scope_name, profile]]

  # ---------------------------------------------------------------------------
  # Portainer — Forward Auth provider
  # ---------------------------------------------------------------------------
  - model: authentik_providers_proxy.proxyprovider
    state: present
    identifiers:
      name: Portainer Forward Auth
    attrs:
      name: Portainer Forward Auth
      authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
      invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]
      mode: forward_single
      external_host: !Format ["https://portainer.%s", !Env "DOMAIN"]
      access_token_validity: hours=12

  # ---------------------------------------------------------------------------
  # FileBrowser — Forward Auth provider
  # ---------------------------------------------------------------------------
  - model: authentik_providers_proxy.proxyprovider
    state: present
    identifiers:
      name: FileBrowser Forward Auth
    attrs:
      name: FileBrowser Forward Auth
      authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
      invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]
      mode: forward_single
      external_host: !Format ["https://files.%s", !Env "DOMAIN"]
      access_token_validity: hours=12

  # ---------------------------------------------------------------------------
  # OpenCloud — OAuth2/OIDC provider (public client, PKCE)
  # ---------------------------------------------------------------------------
  - model: authentik_providers_oauth2.oauth2provider
    state: present
    identifiers:
      name: OpenCloud Provider
    attrs:
      name: OpenCloud Provider
      authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
      client_type: public
      client_id: opencloud
      invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]
      redirect_uris:
        - url: !Format ["https://cloud.%s/", !Env "DOMAIN"]
          matching_mode: prefix
      access_token_validity: hours=1
      refresh_token_validity: days=30
      property_mappings:
        - !Find [authentik_providers_oauth2.scopemapping, [scope_name, openid]]
        - !Find [authentik_providers_oauth2.scopemapping, [scope_name, email]]
        - !Find [authentik_providers_oauth2.scopemapping, [scope_name, profile]]

  # ---------------------------------------------------------------------------
  # Embedded Outpost — assign proxy providers so forward auth works
  # ---------------------------------------------------------------------------
  - model: authentik_outposts.outpost
    state: present
    identifiers:
      name: authentik Embedded Outpost
    attrs:
      providers:
        - !Find [authentik_providers_proxy.proxyprovider, [name, Portainer Forward Auth]]
        - !Find [authentik_providers_proxy.proxyprovider, [name, FileBrowser Forward Auth]]
      config:
        authentik_host: !Format ["https://auth.%s", !Env "DOMAIN"]
        authentik_host_browser: !Format ["https://auth.%s", !Env "DOMAIN"]
        authentik_host_insecure: false
        log_level: info
        docker_labels: null
        docker_network: null
        docker_map_ports: true
        container_image: null
        refresh_interval: "minutes=5"
        kubernetes_replicas: 1
        kubernetes_namespace: default
        object_naming_template: "ak-outpost-%(name)s"
        kubernetes_json_patches: null
        kubernetes_service_type: ClusterIP
        kubernetes_image_pull_secrets: []
        kubernetes_ingress_class_name: null
        kubernetes_disabled_components: []
        kubernetes_ingress_annotations: {}
        kubernetes_ingress_secret_name: authentik-outpost-tls
