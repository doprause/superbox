# =============================================================================
# Authentik Blueprint — OAuth2/OIDC and Forward Auth Providers
# Each service that integrates with SSO gets a provider defined here.
# Applied automatically on startup.
# =============================================================================
version: 1
metadata:
  name: Superbox Providers
  labels:
    blueprints.goauthentik.io/instantiate: "true"

entries:
  # ---------------------------------------------------------------------------
  # Grafana — OAuth2/OIDC provider
  # ---------------------------------------------------------------------------
  - model: authentik_providers_oauth2.oauth2provider
    state: present
    identifiers:
      name: Grafana Provider
    attrs:
      name: Grafana Provider
      authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
      client_type: confidential
      client_id: grafana
      invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]
      redirect_uris:
        - url: !Format ["https://grafana.%s/login/generic_oauth", !Env "DOMAIN"]
          matching_mode: strict
      access_token_validity: hours=1
      refresh_token_validity: days=30
      property_mappings:
        - !Find [authentik_providers_oauth2.scopemapping, [scope_name, openid]]
        - !Find [authentik_providers_oauth2.scopemapping, [scope_name, email]]
        - !Find [authentik_providers_oauth2.scopemapping, [scope_name, profile]]

  # ---------------------------------------------------------------------------
  # Portainer — Forward Auth provider
  # ---------------------------------------------------------------------------
  - model: authentik_providers_proxy.proxyprovider
    state: present
    identifiers:
      name: Portainer Forward Auth
    attrs:
      name: Portainer Forward Auth
      authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
      invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]
      mode: forward_single
      external_host: !Format ["https://portainer.%s", !Env "DOMAIN"]
      access_token_validity: hours=12

  # ---------------------------------------------------------------------------
  # FileBrowser — Forward Auth provider
  # ---------------------------------------------------------------------------
  - model: authentik_providers_proxy.proxyprovider
    state: present
    identifiers:
      name: FileBrowser Forward Auth
    attrs:
      name: FileBrowser Forward Auth
      authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
      invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]
      mode: forward_single
      external_host: !Format ["https://files.%s", !Env "DOMAIN"]
      access_token_validity: hours=12

  # ---------------------------------------------------------------------------
  # Embedded Outpost — assign proxy providers so forward auth works
  # ---------------------------------------------------------------------------
  - model: authentik_outposts.outpost
    state: present
    identifiers:
      name: authentik Embedded Outpost
    attrs:
      providers:
        - !Find [authentik_providers_proxy.proxyprovider, [name, Portainer Forward Auth]]
        - !Find [authentik_providers_proxy.proxyprovider, [name, FileBrowser Forward Auth]]
