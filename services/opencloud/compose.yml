# =============================================================================
# Module: OpenCloud — File sync/share, CalDAV, CardDAV, Collabora editing
# =============================================================================

networks:
  traefik-net:
    external: true
  opencloud-net:
    name: opencloud-net
    external: false

services:

  # ---------------------------------------------------------------------------
  # OpenCloud EU — File sync/share, calendar, contacts, spaces
  # ---------------------------------------------------------------------------
  opencloud:
    image: opencloudeu/opencloud:4.0.3
    container_name: opencloud
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    security_opt:
      - no-new-privileges:true
    networks:
      - traefik-net
      - opencloud-net
    entrypoint: ["/bin/sh", "-c"]
    command: ["if [ ! -f /etc/opencloud/opencloud.yaml ]; then printf 'no\\n' | /usr/bin/opencloud init; fi; exec /usr/bin/opencloud server"]
    # Allow container to resolve custom domains via Docker host → Traefik.
    # On a server with real DNS this is not needed; remove for production.
    extra_hosts:
      - "auth.${DOMAIN}:host-gateway"         # OIDC server-side calls to Authentik
      - "cloud.${DOMAIN}:host-gateway"        # ocdav self-calls (e.g. /data endpoint)
      - "collabora.${DOMAIN}:host-gateway"    # collaboration service → Collabora WOPI app
    volumes:
      - ../../data/opencloud/data:/var/lib/opencloud
      - ../../data/opencloud/config:/etc/opencloud
    environment:
      - TZ=${TZ:-Europe/Berlin}
      - OC_DOMAIN=cloud.${DOMAIN}
      - OC_URL=https://cloud.${DOMAIN}
      - OC_ADMIN_USER=${OC_ADMIN_USER:-admin}
      - OC_ADMIN_PASSWORD=${OC_ADMIN_PASSWORD}
      # Collabora WOPI integration
      # COLLABORA_DOMAIN is used by `opencloud init` to pre-populate the config file.
      # COLLABORATION_* env vars override config at runtime so the collaboration
      # service (WOPI host) actually starts and knows where to find Collabora.
      - COLLABORA_DOMAIN=collabora.${DOMAIN}
      - WOPI_DOMAIN=cloud.${DOMAIN}
      - COLLABORATION_APP_ADDR=https://collabora.${DOMAIN}
      # WOPI_SRC: URL OpenCloud embeds in WOPI tokens for Collabora's server-side callbacks.
      # Using the internal container address avoids DNS resolution and self-signed cert issues.
      # Collabora calls this server-side (not the browser). For production with real DNS +
      # valid certs, change to https://cloud.${DOMAIN}.
      - COLLABORATION_WOPI_SRC=http://opencloud:9200
      # Skip TLS for self-signed cert on Collabora (test server only)
      - COLLABORATION_APP_INSECURE=${OC_INSECURE:-false}
      # Disable WOPI proof key verification (Collabora has no proof key by default;
      # remove for production if Collabora proof_key is configured)
      - COLLABORATION_APP_PROOF_DISABLE=${OC_INSECURE:-false}
      # Disable built-in TLS (Traefik handles it)
      # Set OC_INSECURE=true in .env when using self-signed certs (test server only)
      - OC_INSECURE=${OC_INSECURE:-false}
      - PROXY_TLS=false
      # OIDC / Authentik integration
      # Disable built-in IDP; explicitly add collaboration (not in default service set)
      - OC_EXCLUDE_RUN_SERVICES=idp
      - OC_ADD_RUN_SERVICES=collaboration
      # OC_OIDC_ISSUER: browser-facing public URL — the SPA redirects here for login
      - OC_OIDC_ISSUER=https://auth.${DOMAIN}/application/o/opencloud/
      # PROXY_OIDC_ISSUER: server-side URL for OIDC discovery and token validation
      # extra_hosts above lets the container resolve auth.${DOMAIN} via Docker host → Traefik
      - PROXY_OIDC_ISSUER=https://auth.${DOMAIN}/application/o/opencloud/
      # Skip TLS verification for OIDC discovery (overrides proxy.oidc.insecure in opencloud.yaml)
      # Required when auth.DOMAIN uses a self-signed cert (test server). Remove for production.
      - PROXY_OIDC_INSECURE=true
      # Rewrite /.well-known so the proxy can serve OIDC discovery (IDP is disabled)
      - PROXY_OIDC_REWRITE_WELLKNOWN=true
      # Use userinfo endpoint for token validation instead of JWT verification
      - PROXY_ACCESS_TOKEN_VERIFY_METHOD=none
      - WEB_OIDC_CLIENT_ID=opencloud
      # Serve OIDC metadata from the same OpenCloud origin so the SPA avoids a
      # cross-origin fetch to auth.DOMAIN (which would fail on self-signed certs).
      # The proxy rewrites /.well-known to return the correct Authentik endpoints.
      - WEB_OIDC_METADATA_URL=https://cloud.${DOMAIN}/.well-known/openid-configuration
      # Auto-provision OpenCloud accounts on first OIDC login
      - PROXY_AUTOPROVISION_ACCOUNTS=true
      - PROXY_USER_OIDC_CLAIM=preferred_username
      - PROXY_USER_CS3_CLAIM=username
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.opencloud.rule=Host(`cloud.${DOMAIN}`)"
      - "traefik.http.routers.opencloud.entrypoints=websecure"
      - "traefik.http.routers.opencloud.tls.certresolver=letsencrypt"
      - "traefik.http.routers.opencloud.middlewares=chain-public@file,opencloud-csp"
      - "traefik.http.services.opencloud.loadbalancer.server.port=9200"
      # Override OpenCloud's own restrictive CSP:
      # - connect-src: allow OIDC token/JWKS/userinfo fetches to auth.DOMAIN
      # - frame-src: allow Collabora editor iframe from collabora.DOMAIN
      - "traefik.http.middlewares.opencloud-csp.headers.customResponseHeaders.Content-Security-Policy=child-src 'self'; connect-src 'self' blob: https://auth.${DOMAIN} https://raw.githubusercontent.com/opencloud-eu/awesome-apps/ https://update.opencloud.eu/; default-src 'none'; font-src 'self'; frame-ancestors 'self'; frame-src 'self' blob: https://collabora.${DOMAIN} https://embed.diagrams.net/; img-src 'self' data: blob: https://raw.githubusercontent.com/opencloud-eu/awesome-apps/; manifest-src 'self'; media-src 'self'; object-src 'self' blob:; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'"
      - "com.centurylinklabs.watchtower.enable=true"
      - "com.superbox.module=opencloud"

  # ---------------------------------------------------------------------------
  # Collabora Online — Real-time document/spreadsheet/presentation editing
  # Integrates with OpenCloud via WOPI protocol
  # ---------------------------------------------------------------------------
  collabora:
    image: collabora/code:25.04.9.1.1
    container_name: collabora
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    security_opt:
      # no-new-privileges is intentionally omitted: Collabora's coolforkit binary relies
      # on file capabilities (cap_sys_chroot, cap_fowner, cap_chown) which are blocked by
      # no-new-privileges. seccomp:unconfined allows CLONE_NEWUSER for the -ns sandbox variant.
      - seccomp:unconfined
    cap_add:
      - MKNOD  # Required by Collabora's sandboxing
    networks:
      - traefik-net
      - opencloud-net
    volumes:
      - ../../data/collabora:/opt/collaboraoffice/share/extensions
    environment:
      - TZ=${TZ:-Europe/Berlin}
      - DONT_GEN_SSL_CERT=YES
      # Two separate aliasgroups so both hostnames are treated as primaries and get
      # their hostname properly extracted into the WOPI allowlist and frame-ancestors.
      # Collabora 25.04 bug: alias entries (2nd+ in a group) store the full URI not
      # just the hostname, breaking WOPI vetting and frame-ancestors for alias entries.
      - aliasgroup1=http://opencloud:9200
      - aliasgroup2=https://cloud.${DOMAIN}:443
      - username=admin
      - password=${OC_ADMIN_PASSWORD}
      - extra_params=--o:ssl.enable=false --o:ssl.termination=true
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.collabora.rule=Host(`collabora.${DOMAIN}`)"
      - "traefik.http.routers.collabora.entrypoints=websecure"
      - "traefik.http.routers.collabora.tls.certresolver=letsencrypt"
      - "traefik.http.routers.collabora.middlewares=chain-public@file"
      - "traefik.http.services.collabora.loadbalancer.server.port=9980"
      - "com.centurylinklabs.watchtower.enable=true"
      - "com.superbox.module=opencloud"

  # ---------------------------------------------------------------------------
  # Apache Tika — Full-text extraction for OpenCloud search indexing
  # ---------------------------------------------------------------------------
  tika:
    image: apache/tika:3.2.3.0
    container_name: tika
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    security_opt:
      - no-new-privileges:true
    networks:
      - opencloud-net
    labels:
      - "com.superbox.module=opencloud"
