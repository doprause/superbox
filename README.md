# Superbox

All-in-one small business server — modular, secure, Docker Compose-based.

Runs on **Ubuntu 24.04 LTS** (bare-metal or VM). The entire stack is declared as code and can be reproduced from scratch with a single command.

---

## Architecture

```
Internet / LAN
       │
   Traefik v3  ◄── CrowdSec bouncer (IP reputation, rate limiting)
       │
   Authentik (OIDC / OAuth2 / SAML / forward-auth)
       │
   ├── OpenCloud EU  (files, calendar, contacts)
   │     └── Collabora Online  (document editing via WOPI)
   ├── Monitoring    (Prometheus + Grafana + cAdvisor)
   ├── NAS           (Samba + FileBrowser)
   ├── Backup        (Duplicati)
   ├── Passwords     (Bitwarden Lite)
   └── Management    (Portainer + Homepage dashboard)
```

---

## Modules

| Module | Services | Toggle |
|--------|----------|--------|
| **Infrastructure** | Traefik v3, CrowdSec, Socket Proxy | Required |
| **Management** | Portainer CE, Homepage, Watchtower | Required |
| **Auth** | Authentik, PostgreSQL, Redis | Recommended |
| **OpenCloud** | OpenCloud EU, Collabora, Tika | Optional |
| **Monitoring** | Prometheus, Grafana, node-exporter, cAdvisor, Alertmanager | Optional |
| **NAS** | Samba (SMB2+/3), FileBrowser | Optional |
| **Backup** | Duplicati | Optional |
| **Passwords** | Bitwarden Lite | Optional |

Enable or disable a module by commenting out its line in `docker-compose.yml`.

---

## Quick Start

### Prerequisites

- Ubuntu 24.04 LTS
- Docker CE + Docker Compose v2.20+
- A domain with DNS pointing to your server

### 1. Clone and set up

```bash
git clone https://github.com/doprause/superbox.git
cd superbox
make setup
```

`make setup` will:
- Check Docker and Docker Compose versions
- Generate all secrets and write them to `.env`
- Create the `data/` directory tree
- Set `acme.json` to the required `600` permissions
- Print a post-install checklist with your generated credentials

### 2. Configure

Edit `.env` and set at minimum:

```env
DOMAIN=yourdomain.com
ACME_EMAIL=admin@yourdomain.com
USE_LETSENCRYPT=true
```

For Bitwarden Lite, obtain an installation ID and key from [bitwarden.com/host](https://bitwarden.com/host) and add them to `.env`.

### 3. Start

```bash
make up
```

---

## DNS Records

Point these A records to your server's IP before starting:

| Subdomain | Service |
|-----------|---------|
| `yourdomain.com` | Homepage dashboard |
| `auth.yourdomain.com` | Authentik SSO |
| `cloud.yourdomain.com` | OpenCloud |
| `collabora.yourdomain.com` | Collabora Online |
| `grafana.yourdomain.com` | Grafana |
| `prometheus.yourdomain.com` | Prometheus |
| `portainer.yourdomain.com` | Portainer |
| `files.yourdomain.com` | FileBrowser |
| `vault.yourdomain.com` | Bitwarden |
| `backup.yourdomain.com` | Duplicati |
| `traefik.yourdomain.com` | Traefik dashboard |

---

## Makefile Reference

```
make setup      First-run: generate secrets, create data dirs
make up         Start all services
make down       Stop all services
make restart    Restart all services
make logs       Follow logs (last 50 lines)
make ps         Show running containers and health
make pull       Pull latest images
make update     Pull images and recreate changed containers
make backup     Trigger a Duplicati backup via API
make provision  Run Ansible playbook (host provisioning)
make validate   Validate Docker Compose config
make check-env  Verify .env exists
```

---

## Host Provisioning (Ansible)

To provision a fresh Ubuntu 24.04 server from scratch:

```bash
cp ansible/inventory.example ansible/inventory
# Edit ansible/inventory with your server's IP and SSH key
make provision
```

The playbook installs Docker, configures UFW, applies sysctl hardening, creates the `superbox` system user, and starts the stack as a systemd service.

Optionally enable ZFS storage by setting `enable_zfs: true` and `zfs_disk: /dev/sdX` in `ansible/playbook.yml`.

---

## Security

| Control | Implementation |
|---------|---------------|
| TLS everywhere | Traefik Let's Encrypt ACME; HTTP→HTTPS redirect; TLS 1.2+ |
| Intrusion detection | CrowdSec with Traefik log analysis + bouncer |
| SSO + MFA | Authentik forward auth on all admin UIs; TOTP for admins |
| Security headers | HSTS, CSP, X-Frame-Options, X-Content-Type via Traefik middleware |
| Rate limiting | 100 req/s avg, 50 burst per IP |
| Docker API | Socket Proxy blocks AUTH/SECRETS endpoints |
| No root containers | `user: "1000:1000"` or image-native non-root |
| No privilege escalation | `no-new-privileges:true` on all services |
| Isolated networks | Databases have no connection to `traefik-net` |
| Secrets | Generated by `setup.sh`; stored in `.env`; never committed |
| Host firewall | UFW via Ansible; `DOCKER-USER` chain prevents Docker bypass |

---

## Directory Structure

```
superbox/
├── ansible/                    # Host provisioning (Ansible)
│   ├── playbook.yml
│   ├── inventory.example
│   └── roles/
│       ├── base/               # OS packages, sysctl hardening
│       ├── docker/             # Docker CE + Compose plugin
│       ├── firewall/           # UFW + DOCKER-USER iptables chain
│       ├── storage/            # Optional ZFS configuration
│       └── superbox/           # User, dirs, systemd service
├── docker-compose.yml          # Master orchestrator (include directives)
├── .env.example                # Secret template (committed)
├── .env                        # Secrets (gitignored — generated by setup.sh)
├── Makefile
├── scripts/
│   └── setup.sh                # First-run setup and secret generation
├── services/
│   ├── infrastructure/         # Traefik, CrowdSec, Socket Proxy
│   ├── management/             # Portainer, Homepage, Watchtower
│   ├── auth/                   # Authentik + blueprints (IaC SSO config)
│   ├── opencloud/              # OpenCloud EU, Collabora, Tika
│   ├── monitoring/             # Prometheus, Grafana, exporters
│   ├── nas/                    # Samba, FileBrowser
│   ├── backup/                 # Duplicati
│   └── passwords/              # Bitwarden Lite
└── data/                       # Persistent volumes (gitignored)
```

---

## Backup Strategy

Duplicati backs up nightly at 02:00 with AES-256 client-side encryption:

| Source | Path |
|--------|------|
| OpenCloud files | `data/opencloud` |
| Authentik config | `data/authentik` |
| NAS shares | `data/nas/shares` |
| Passwords | `data/passwords` |

Targets: local disk + optional offsite (S3, Backblaze B2, SFTP, Google Drive). Configure via the Duplicati web UI at `backup.yourdomain.com`.

---

## Versioning

This project follows [Semantic Versioning](https://semver.org/) (`MAJOR.MINOR.PATCH`):

| Increment | When |
|-----------|------|
| `MAJOR` | Breaking changes (renamed env vars, removed services, incompatible data migrations) |
| `MINOR` | New modules or significant new features, backwards-compatible |
| `PATCH` | Bug fixes, config corrections, documentation updates |

Releases are tagged on `main` (e.g. `v1.2.0`). The changelog is maintained in [CHANGELOG.md](CHANGELOG.md).

### Pinned image versions

All container images are pinned to `major.minor` version tags (not `:latest`) to ensure reproducible deployments. When upgrading, check the upstream changelog for breaking changes before pulling new images.

---

## License

MIT
