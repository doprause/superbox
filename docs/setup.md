# Superbox — Setup Guide

Exact, step-by-step guide based on the actual working configuration. Includes lessons learned during testing.

---

## Prerequisites

| Requirement | Minimum |
|---|---|
| OS | Ubuntu 24.04 LTS (or any Linux with Docker) |
| Docker CE | any recent version |
| Docker Compose plugin | v2.20+ (required for `include` support) |
| `openssl` | for secret generation |
| Ports open | 80/tcp, 443/tcp (+ 445/tcp and 137-139/udp for Samba) |

`setup.sh` checks for all of these and offers to install what's missing.

---

## 1. Clone and configure

```bash
git clone https://github.com/doprause/superbox.git
cd superbox
cp .env.example .env
nano .env
```

**Required values to set manually** — everything else is generated by `setup.sh`:

```bash
DOMAIN=yourdomain.com          # e.g. superbox.local for LAN-only
ACME_EMAIL=admin@example.com
USE_LETSENCRYPT=true            # false for self-signed / local domains
TZ=Europe/Berlin

# Bitwarden: get from https://bitwarden.com/host/
BITWARDEN_INSTALLATION_ID=
BITWARDEN_INSTALLATION_KEY=
```

**Disable optional modules** by commenting out lines in `docker-compose.yml`:

```yaml
include:
  - ./services/infrastructure/compose.yml   # REQUIRED
  - ./services/management/compose.yml        # REQUIRED
  - ./services/auth/compose.yml              # recommended
  - ./services/opencloud/compose.yml         # optional
  - ./services/monitoring/compose.yml        # optional
  - ./services/nas/compose.yml               # optional
  - ./services/backup/compose.yml            # optional
  - ./services/passwords/compose.yml         # optional
```

---

## 2. DNS

Point an A record for each subdomain to your server IP. With a wildcard record (`*.yourdomain.com`) you only need one entry.

| Subdomain | Service |
|---|---|
| `auth.DOMAIN` | Authentik SSO |
| `cloud.DOMAIN` | OpenCloud |
| `grafana.DOMAIN` | Grafana |
| `portainer.DOMAIN` | Portainer |
| `files.DOMAIN` | FileBrowser |
| `vault.DOMAIN` | Bitwarden |
| `backup.DOMAIN` | Duplicati |
| `traefik.DOMAIN` | Traefik dashboard |

**Local/test server:** Add a wildcard entry to your hosts file:
```
192.168.x.x  yourdomain.com *.yourdomain.com
```
On Windows: `C:\Windows\System32\drivers\etc\hosts`.

---

## 3. TLS

**Public domain (USE_LETSENCRYPT=true):**
Traefik requests Let's Encrypt certs automatically via HTTP-01 challenge. Port 80 must be reachable from the internet.

**Local/test (USE_LETSENCRYPT=false):**
`setup.sh` generates a self-signed wildcard cert for `*.DOMAIN`. Traefik serves it from `data/traefik/certs/cert.pem`.
The browser will show a security warning — accept it once per domain. In incognito mode you must accept the cert warning for **each subdomain separately** before OIDC flows will work (the SPA fetches from multiple origins).

Set in `.env`:
```bash
USE_LETSENCRYPT=false
OC_INSECURE=true          # OpenCloud only — tells it to skip TLS verification
```

---

## 4. Run setup

```bash
sudo bash scripts/setup.sh
```

What it does:
- Checks/installs Docker, Compose plugin, openssl
- Creates `.env` from template and generates all secrets
- Creates `data/` directory tree with correct ownership (including container-specific UIDs like postgres=70, redis=999, grafana=472, prometheus=65534)
- Creates `data/filebrowser/settings.json` as a file (not directory) — Docker would create it as a directory on bind-mount otherwise
- Creates and `chmod 600` the `acme.json` file
- Generates the self-signed TLS fallback cert

Generated credentials are printed at the end. **Save them — they're only shown once.**
They're also stored in `.env`.

---

## 5. Start the stack

```bash
make up
# or: docker compose up -d
```

Check status:
```bash
make ps
make logs
```

---

## 6. First-login steps

### Authentik

Go to `https://auth.DOMAIN` and log in with:
- Username: `akadmin`
- Password: the value of `AUTHENTIK_BOOTSTRAP_PASSWORD` in `.env`

> **Pitfall:** `AUTHENTIK_BOOTSTRAP_PASSWORD` is only applied on the very first database init.
> If Authentik was started once before (e.g. with an empty password), the bootstrap env var is ignored and the password stays as whatever was set initially.
> Fix: reset via the UI (Admin → Directory → Users → akadmin → Set password) or via:
> ```bash
> docker exec -it authentik-server ak set_password --username akadmin --password 'NewPassword'
> ```

Blueprints in `services/auth/authentik/blueprints/` are applied automatically by the worker on startup. They configure:
- Groups: `superbox-admins`, `superbox-users`
- Providers: Grafana OAuth2, Portainer forward auth, FileBrowser forward auth, OpenCloud OIDC
- Applications: all services with icons and launch URLs
- Embedded Outpost: assigned Portainer and FileBrowser proxy providers

Check blueprint status: Admin → System → Blueprints. All should show `Successful`.

### Portainer

Go to `https://portainer.DOMAIN`. Authentik forward auth intercepts — log in with Authentik.

### Grafana

Go to `https://grafana.DOMAIN`. Click "Sign in with Authentik". On first login, Grafana auto-creates your account.

> The Grafana OAuth secret (`GRAFANA_OAUTH_SECRET`) must be in both `.env` (Grafana reads it) **and** passed to `authentik-worker` via its environment block (so the blueprint `!Env "GRAFANA_OAUTH_SECRET"` resolves). This is already wired up in `services/auth/compose.yml`.

### FileBrowser

Go to `https://files.DOMAIN`. FileBrowser itself has `noAuth: true` — Authentik's forward auth gate handles login. There is no separate FileBrowser login.

### OpenCloud

Go to `https://cloud.DOMAIN`. You are redirected to Authentik for login. After authenticating, OpenCloud auto-provisions your account on first login.

Admin login (bypasses OIDC, direct OpenCloud auth):
- Username: value of `OC_ADMIN_USER` (default: `admin`)
- Password: value of `OC_ADMIN_PASSWORD` in `.env`

---

## 7. Service URLs

| Service | URL | Auth |
|---|---|---|
| Authentik | `https://auth.DOMAIN` | Authentik (akadmin) |
| OpenCloud | `https://cloud.DOMAIN` | Authentik SSO (OIDC) |
| Collabora | internal only (via OpenCloud) | — |
| Grafana | `https://grafana.DOMAIN` | Authentik OAuth2 |
| Portainer | `https://portainer.DOMAIN` | Authentik forward auth |
| FileBrowser | `https://files.DOMAIN` | Authentik forward auth |
| Bitwarden | `https://vault.DOMAIN` | Bitwarden own auth |
| Duplicati | `https://backup.DOMAIN` | Authentik forward auth |
| Traefik dashboard | `https://traefik.DOMAIN` | Authentik forward auth |

---

## 8. Makefile reference

```bash
make setup      # run setup.sh (first-run, safe to re-run)
make up         # docker compose up -d
make down       # docker compose down
make restart    # docker compose restart
make logs       # docker compose logs -f --tail=50
make ps         # docker compose ps
make pull       # docker compose pull
make update     # pull + recreate changed containers
make provision  # ansible-playbook ansible/playbook.yml -i ansible/inventory
```

---

## Pitfalls & findings

This section documents every non-obvious issue encountered during setup.

### Authentik blueprints (version 2025.2)

All syntax changes are already applied in the repo. Document for reference:

- **`!Format` tag**: must be a flat array — `!Format ["https://%s/path", !Env "DOMAIN"]`.
  A nested array (`!Format [!Env "DOMAIN"]`) silently fails.
- **`invalidation_flow`**: required on every provider (OAuth2 and proxy) in 2025.2. Use slug `default-provider-invalidation-flow`.
- **`redirect_uris`**: changed from a list of strings to a list of dicts:
  ```yaml
  redirect_uris:
    - url: https://example.com/callback
      matching_mode: strict   # or: regex (not prefix — not supported in 2025.2)
  ```
- **`DOMAIN` env var in worker**: `DOMAIN=${DOMAIN}` must be explicitly set in the `authentik-worker` environment block. Blueprints on the worker process use `!Env "DOMAIN"` — it won't resolve from Authentik's own config.
- **Signing key on OAuth2 providers**: the OpenCloud provider (and any public PKCE client) must have `signing_key` set to a real key pair, otherwise Authentik returns an empty JWKS (`{}`) and token verification silently hangs. Use:
  ```yaml
  signing_key: !Find [authentik_crypto.certificatekeypair, [name, authentik Self-signed Certificate]]
  ```

### FileBrowser v2

- Default config path changed to `/config/settings.json` (not `/config/config.json`).
- Default database path changed to `/database/filebrowser.db`.
- `setup.sh` must create `data/filebrowser/settings.json` as a **file** before first container start. If the file doesn't exist, Docker creates it as a directory on bind-mount, and FileBrowser fails to start.
- Set `"noAuth": true` in `settings.json` so FileBrowser doesn't intercept requests — Authentik handles the login gate.

### Grafana OAuth2

- `GF_AUTH_GENERIC_OAUTH_TOKEN_URL` and `GF_AUTH_GENERIC_OAUTH_API_URL` must point to the **internal** container hostname `http://authentik-server:9000/...`, not the public domain. Docker containers cannot resolve a custom domain (like `auth.superbox.local`) from inside the network via regular DNS.
- `GF_AUTH_GENERIC_OAUTH_AUTH_URL` stays as the public domain — it's browser-facing.

### OpenCloud OIDC (most complex integration)

**Architecture:**
OpenCloud uses a public PKCE client. The SPA (browser) handles the OIDC flow client-side. The OpenCloud server-side proxy validates tokens via the userinfo endpoint.

**Required env vars explained:**

| Var | Value | Why |
|---|---|---|
| `extra_hosts` | `auth.${DOMAIN}:host-gateway` | Allows the container to resolve the custom domain via Docker host → Traefik → Authentik for server-side OIDC calls |
| `PROXY_OIDC_ISSUER` | `https://auth.${DOMAIN}/application/o/opencloud/` | Public HTTPS URL (extra_hosts handles DNS resolution) |
| `PROXY_OIDC_INSECURE` | `true` | Overrides `proxy.oidc.insecure: false` hardcoded in `opencloud.yaml` by `opencloud init`. Required for self-signed certs. |
| `PROXY_OIDC_REWRITE_WELLKNOWN` | `true` | OpenCloud proxy serves OIDC discovery at `/.well-known/openid-configuration`, rewriting Authentik's endpoints |
| `WEB_OIDC_METADATA_URL` | `https://cloud.${DOMAIN}/.well-known/openid-configuration` | Points the SPA's metadata fetch at the **same origin** (cloud.DOMAIN), avoiding a cross-origin cert error. The proxy rewrites it transparently to Authentik. |
| `PROXY_ACCESS_TOKEN_VERIFY_METHOD` | `none` | Validates tokens via userinfo endpoint, not JWT signature (correct for public PKCE clients) |
| `PROXY_AUTOPROVISION_ACCOUNTS` | `true` | Auto-creates OpenCloud user on first OIDC login |

**CSP override:**
OpenCloud sets its own `Content-Security-Policy` response header with `connect-src 'self' blob: ...` — no external origins. This blocks the oidc-client SPA from reaching the Authentik token endpoint, JWKS endpoint, and userinfo endpoint.

Fix: a Traefik per-service middleware overwrites the CSP header:
```yaml
labels:
  - "traefik.http.routers.opencloud.middlewares=chain-public@file,opencloud-csp"
  - "traefik.http.middlewares.opencloud-csp.headers.customResponseHeaders.Content-Security-Policy=child-src 'self'; connect-src 'self' blob: https://auth.${DOMAIN} ...; ..."
```
Docker Compose expands `${DOMAIN}` in label values from `.env`.

### Traefik security headers and CSP

The global `security-headers` middleware intentionally omits `Content-Security-Policy`. A global `connect-src 'self'` would break every SPA (OpenCloud, Grafana) that needs to call the Authentik domain. Add per-service CSP via Traefik labels where needed.

### Self-signed cert in incognito mode

In incognito (private browsing), the browser doesn't inherit the user's cert exceptions. Each origin (`auth.DOMAIN`, `cloud.DOMAIN`, etc.) must have its cert exception accepted before OIDC flows work. If the SPA's metadata fetch silently fails, check incognito cert warnings first.
