# Security

This document describes the security controls applied across the Superbox stack and provides a reference for auditing the configuration.

## Defense in Depth

The stack is designed with multiple independent security layers. Bypassing one layer does not grant access to the underlying service.

```
External request
    │
    ▼
[1] UFW firewall         — blocks all ports except 80, 443, 22
    │
    ▼
[2] CrowdSec bouncer     — blocks IPs with known bad reputation
    │
    ▼
[3] Traefik TLS          — TLS 1.2+ termination, HTTP→HTTPS redirect
    │
    ▼
[4] Rate limiter         — 100 req/s avg, 50 burst per IP
    │
    ▼
[5] Authentik auth       — valid session or redirect to login
    │
    ▼
[6] Application          — runs as non-root, no-new-privileges
```

---

## Network Isolation

### UFW (host firewall)

Managed by the Ansible `firewall` role. Default policy: deny inbound, allow outbound.

| Rule | Port | Protocol | Source |
|------|------|----------|--------|
| Allow SSH | 22 | TCP | Any |
| Allow HTTP | 80 | TCP | Any |
| Allow HTTPS | 443 | TCP | Any |
| Allow Samba | 139, 445 | TCP | LAN subnet |
| Allow Samba | 137, 138 | UDP | LAN subnet |

### DOCKER-USER chain

Docker bypasses UFW by default — it inserts iptables DNAT rules that take effect before UFW's INPUT chain. The `DOCKER-USER` chain is inserted by the `firewall` role to prevent this. Container ports mapped to the host (e.g. `80:80`) are protected by UFW rules.

### Docker networks

Services are connected only to the networks they strictly need:

| Service type | Connected to |
|-------------|-------------|
| Databases (`authentik-db`, `authentik-redis`) | `auth-net` only |
| Backend-only services (`tika`, `node-exporter`, `cadvisor`) | Internal networks only |
| Web-facing services | `traefik-net` + their module network |
| Docker API consumers (Portainer, Watchtower) | `socket-proxy-net` only |
| Traefik | Direct read-only socket mount (reads labels only) |

---

## Container Hardening

Applied to every service in the stack:

### `no-new-privileges`

```yaml
security_opt:
  - no-new-privileges:true
```

Prevents processes inside the container from gaining additional privileges via `setuid` binaries or capabilities.

### Non-root users

| Service | User |
|---------|------|
| `authentik-db` | `70:70` (postgres) |
| `authentik-redis` | `999:999` (redis) |
| `prometheus`, `alertmanager` | `65534:65534` (nobody) |
| `grafana` | `472:472` (grafana) |
| `filebrowser`, `duplicati` | `${PUID}:${PGID}` (1000:1000) |

Services that must run as root (Samba, cAdvisor) are noted and justified in their module docs.

### Capability dropping

Where images permit, capabilities are dropped at the service level. The `cap_drop: [ALL]` pattern is recommended when adding new services. Collabora requires `MKNOD` for its sandboxing — this is the only exception.

### Read-only filesystems

Where possible, configuration files are mounted `:ro`:

```yaml
volumes:
  - ./services/infrastructure/traefik/traefik.yml:/etc/traefik/traefik.yml:ro
  - ./services/infrastructure/traefik/dynamic:/etc/traefik/dynamic:ro
  - ./services/auth/authentik/blueprints:/blueprints/superbox:ro
  - ./services/monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
```

---

## Secrets Management

### Generation

All secrets are generated by `setup.sh` using `openssl rand`:

```bash
openssl rand -base64 48 | tr -dc 'a-zA-Z0-9' | head -c 64
```

Generated secrets:
- `AUTHENTIK_SECRET_KEY` — cookie/token signing key
- `AUTHENTIK_BOOTSTRAP_PASSWORD` — initial admin password
- `POSTGRES_PASSWORD` — database password
- `OC_ADMIN_PASSWORD` — OpenCloud admin
- `CROWDSEC_BOUNCER_KEY` — CrowdSec API key
- `GRAFANA_ADMIN_PASSWORD` — Grafana admin
- `FILEBROWSER_ADMIN_PASSWORD` — FileBrowser admin
- `BACKUP_PASSPHRASE` — Duplicati encryption passphrase

### Storage

- Secrets are stored in `.env` (gitignored)
- `.env` is never committed
- `.env.example` (committed) contains only empty placeholders and comments
- `AUTHENTIK_SECRET_KEY` must not change after first boot — it signs existing sessions

### Docker secrets note

This stack uses environment variables (`.env`) rather than Docker Swarm secrets. In a Docker Swarm or Kubernetes environment, consider migrating to native secret management.

---

## TLS Configuration

### Certificate management

Traefik manages Let's Encrypt certificates automatically via ACME HTTP-01 challenge. Certificates are stored in `services/infrastructure/traefik/acme.json` (chmod 600, gitignored).

A self-signed fallback certificate is auto-generated by `setup.sh` and stored in `data/traefik/certs/`. It is configured as Traefik's default certificate via `dynamic/certs.yml` and is served when no ACME cert matches the requested hostname. This prevents TLS handshake failures (OpenSSL 3.0 treats `unrecognized_name` as a fatal error in TLS 1.3) on local domains or during initial stack startup before ACME issuance.

### TLS profiles

Defined in `services/infrastructure/traefik/dynamic/tls.yml`:

| Profile | Min version | Applied to |
|---------|-------------|-----------|
| `default` | TLS 1.2 | All routers (automatic) |
| `modern` | TLS 1.3 | Bitwarden vault |

TLS 1.0 and 1.1 are disabled stack-wide. Only ECDHE cipher suites are permitted.

### HSTS

Set via the `security-headers` middleware:

```yaml
stsSeconds: 31536000        # 1 year
stsIncludeSubdomains: true
stsPreload: true
```

---

## HTTP Security Headers

Applied by the `security-headers` middleware to all responses:

| Header | Value | Purpose |
|--------|-------|---------|
| `Strict-Transport-Security` | `max-age=31536000; includeSubDomains; preload` | Force HTTPS |
| `X-Frame-Options` | `SAMEORIGIN` | Prevent clickjacking |
| `X-Content-Type-Options` | `nosniff` | Prevent MIME sniffing |
| `Referrer-Policy` | `strict-origin-when-cross-origin` | Limit referrer leakage |
| `Permissions-Policy` | `camera=(), microphone=(), geolocation=()` | Disable sensitive APIs |
| `Content-Security-Policy` | `default-src 'self'; ...` | Restrict resource origins |
| `Server` | *(removed)* | Hide server identity |
| `X-Powered-By` | *(removed)* | Hide framework identity |

---

## Docker Socket Proxy

The Docker API socket (`/var/run/docker.sock`) grants root-equivalent host access. The Socket Proxy restricts Docker API access for services that need container lifecycle operations (Portainer, Watchtower). Traefik mounts the socket directly as read-only (`:ro`) — it only reads container labels and does not perform any write operations. The Socket Proxy blocks:

- `AUTH` — registry credentials
- `SECRETS` — Swarm secret management
- `BUILD` — image building
- `COMMIT` — container commits
- `EXEC` — command execution in containers

---

## CrowdSec Threat Detection

CrowdSec analyses Traefik access logs in real time and shares threat intelligence with the CrowdSec community network. Detected attackers are banned by the Traefik bouncer middleware.

Installed scenarios detect:
- HTTP brute force (login endpoints)
- CVE exploit attempts
- Port scanning
- Bad user agents
- Path traversal

Review active bans: `docker exec crowdsec cscli decisions list`

---

## Authentik SSO and MFA

All admin UIs (Portainer, Traefik dashboard, Prometheus, Alertmanager, Duplicati, FileBrowser) are behind Authentik forward auth. Unauthenticated access redirects to the login page.

For `superbox-admins` group members, TOTP MFA is enforced on every login. MFA cannot be bypassed via forward auth — the session is only created after successful MFA.

---

## Auditing

### Verify no containers run as root

```bash
docker compose ps --format json | jq -r '.[] | "\(.Name): \(.User)"'
```

### Check open ports

```bash
ss -tlnp | grep -E ':(80|443|22|445|139)\b'
```

### Review Traefik middleware on all routers

```bash
docker exec traefik traefik version
curl -s http://localhost:8899/metrics | grep traefik_router
```

### Check UFW status

```bash
sudo ufw status verbose
```

### Verify acme.json permissions

```bash
stat services/infrastructure/traefik/acme.json
# Should show: 600
```
