# Backup

The backup module provides automated, encrypted backups of all persistent data using Duplicati.

**Location:** `services/backup/`

## Components

| Container | Image | Role |
|-----------|-------|------|
| `duplicati` | `duplicati/duplicati:2.0.9` | Web UI backup tool with local and offsite support |

## URL

| URL | Access |
|-----|--------|
| `https://backup.${DOMAIN}` | Duplicati web UI — `chain-internal` (Authentik forward auth) |

---

## Overview

Duplicati performs client-side AES-256 encrypted backups. Data is encrypted **before** it leaves the server — the backup target (S3, SFTP, etc.) only ever sees encrypted blocks. Even if the backup target is compromised, your data cannot be read without the passphrase.

### Backup sources

The following directories are mounted read-only into the Duplicati container:

| Source | Container path | Contents |
|--------|---------------|---------|
| `data/opencloud` | `/source/opencloud` | OpenCloud files, metadata, spaces |
| `data/authentik` | `/source/authentik` | Authentik media, templates, certificates |
| `data/nas/shares` | `/source/nas` | NAS shared files |
| `data/passwords` | `/source/passwords` | Bitwarden Lite data |

Duplicati's own job database (`data/backup/config`) is stored outside the backup sources — this is backed up by Duplicati itself, included in its own backup job.

---

## Configuration

### First-time setup

1. Navigate to `https://backup.${DOMAIN}`
2. Duplicati's setup wizard opens
3. Click **Add backup** → **Configure a new backup**

### Recommended backup job settings

**General:**
- Name: `Superbox Full Backup`
- Encryption: `AES-256-CBC` (pre-filled from `BACKUP_PASSPHRASE` env var)

**Destination (choose one):**

| Target | Example URL |
|--------|-------------|
| Local disk | `/restore` or a USB drive mount |
| S3 / compatible | `s3://bucket-name/superbox/` |
| Backblaze B2 | `b2://bucket-name/superbox/` |
| SFTP | `ssh://user@host/path/to/backups/` |
| Google Drive | Configure via OAuth in the Duplicati UI |

**Source data:**
- Add `/source/opencloud`, `/source/authentik`, `/source/nas`, `/source/passwords`

**Schedule:**
- Run: Daily
- Time: `02:00`

**Retention:**
```
Keep 1 backup per day for: 7 days
Keep 1 backup per week for: 4 weeks
Keep 1 backup per month for: 6 months
```

---

## Backup Passphrase

The backup encryption passphrase is generated by `setup.sh` and stored in `.env` as `BACKUP_PASSPHRASE`. It is passed to Duplicati via the `SETTINGS_ENCRYPTION_KEY` environment variable.

**Store this passphrase somewhere safe and offline.** Without it, encrypted backups cannot be restored. Consider storing it in Bitwarden or printing it and storing it securely.

---

## Restore

### Restore via Duplicati UI

1. Go to `https://backup.${DOMAIN}`
2. Select the backup job → **Restore files**
3. Choose a restore point
4. Select files or directories to restore
5. Set the destination (restore to original location or `/restore`)

### Restore staging area

`data/backup/restore/` is mounted into the container at `/restore`. Use this as a staging area for restores before moving files to their final location.

### Bare-metal restore

If the server is lost:

1. Provision a fresh Ubuntu 24.04 machine (`make provision` or manual Docker install)
2. Clone the repository and run `make setup`
3. Restore `.env` from your secure backup (it contains all secrets)
4. Start Duplicati: `docker compose up -d duplicati`
5. In the Duplicati UI, configure the backup job pointing to your backup target
6. Restore all source directories to their original paths under `data/`
7. Start the full stack: `make up`

---

## Triggering a Manual Backup

Via Makefile:

```bash
make backup
```

Via Duplicati UI:

1. Go to `https://backup.${DOMAIN}`
2. Click the run button (▶) next to the backup job

---

## Verifying Backups

Duplicati can verify backup integrity by downloading a sample of blocks and checking their checksums. Schedule automatic verification:

1. In the backup job settings → **Advanced options**
2. Set `--backup-test-percentage=10` to verify 10% of blocks after each backup

Manual verification:

1. Select backup job → **Verify files**

---

## Monitoring Backup Status

Check Duplicati logs in the UI: select backup job → **Show log**.

For automated monitoring, Duplicati can send notifications via:
- Email (configure SMTP in Settings → Notifications)
- A webhook (set `--send-http-url` in advanced options)

To integrate with the monitoring module, Duplicati exposes a REST API that Prometheus can scrape with a custom exporter.

---

## Offsite Backup Target

Set `BACKUP_TARGET_URL` in `.env` before running `make setup`, or update it manually:

```env
# Amazon S3
BACKUP_TARGET_URL=s3://my-bucket/superbox/

# Backblaze B2
BACKUP_TARGET_URL=b2://my-bucket/superbox/

# SFTP
BACKUP_TARGET_URL=ssh://backup-user@offsite-server/backups/superbox/
```

Then configure this URL as the destination when setting up the Duplicati job.
