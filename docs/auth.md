# Auth — Authentik SSO

Authentik is the identity provider for the entire stack. It handles user authentication, single sign-on (SSO), multi-factor authentication (MFA), and issues tokens to OIDC/OAuth2-native services.

**Location:** `services/auth/`

## Components

| Container | Image | Role |
|-----------|-------|------|
| `authentik-server` | `ghcr.io/goauthentik/server:2025.2` | OIDC/OAuth2/SAML IdP, SSO portal, user management UI |
| `authentik-worker` | `ghcr.io/goauthentik/server:2025.2` | Background tasks: email, webhooks, blueprint application |
| `authentik-db` | `postgres:16-alpine` | Authentik's PostgreSQL database |
| `authentik-redis` | `redis:7-alpine` | Session store and task queue |

`authentik-db` and `authentik-redis` are connected to `auth-net` only — they are not reachable from `traefik-net` or any other network.

## Access Points

| URL | Purpose |
|-----|---------|
| `https://auth.${DOMAIN}` | SSO portal — user login, self-service, app launcher |
| `https://auth.${DOMAIN}/if/admin/` | Admin interface |
| `https://auth.${DOMAIN}/if/flow/initial-setup/` | First-run setup |

## Authentication Methods

### Forward Auth

For services without native OIDC support (Portainer, FileBrowser), Traefik's `authentik-forward-auth` middleware forwards every request to Authentik's forward auth endpoint:

```
GET https://auth.yourdomain.com/outpost.goauthentik.io/auth/traefik
```

If the user has a valid session cookie, Authentik returns HTTP 200 with identity headers. If not, it returns HTTP 302 redirecting to the login page. After login, Authentik redirects back to the original URL.

Identity headers injected by Authentik on success:

| Header | Value |
|--------|-------|
| `X-authentik-username` | Username |
| `X-authentik-email` | Email address |
| `X-authentik-groups` | Pipe-separated group list |
| `X-authentik-name` | Display name |
| `X-authentik-uid` | User UUID |

### OAuth2 / OIDC

For services with native OAuth2 support (Grafana), Authentik acts as the authorization server. The service redirects to Authentik for login and receives an ID token in return. No forward auth middleware is needed — the service manages its own session.

## Blueprints (IaC)

Authentik supports declarative YAML blueprints that configure the IdP as code. Blueprints are stored in `services/auth/authentik/blueprints/` and mounted into both the server and worker containers. The worker applies them automatically on startup.

### Blueprint files

| File | Contents |
|------|---------|
| `groups.yaml` | `superbox-admins` and `superbox-users` groups |
| `providers.yaml` | OAuth2 provider for Grafana; forward auth providers for Portainer, FileBrowser |
| `applications.yaml` | Application entries (appear in the Authentik portal) |
| `flows.yaml` | MFA enrollment flow; admin MFA enforcement policy |

### Verifying blueprint status

1. Log into Authentik as admin
2. Navigate to **System → Blueprints**
3. All Superbox blueprints should show **Successful**

To re-apply a blueprint manually:

```bash
docker exec authentik-worker ak apply_blueprint /blueprints/superbox/providers.yaml
```

### Adding a new application

1. Create a new provider entry in `providers.yaml`
2. Create a new application entry in `applications.yaml` referencing the provider
3. Restart the worker to apply: `docker compose restart authentik-worker`

For OAuth2/OIDC services, also configure the client ID, client secret, and redirect URIs in the service's own configuration (e.g. Grafana's `GF_AUTH_GENERIC_OAUTH_*` env vars).

## Groups and Permissions

| Group | Access | MFA |
|-------|--------|-----|
| `superbox-admins` | All services, Authentik admin UI | Enforced (TOTP) |
| `superbox-users` | All non-admin services | Optional |

Groups are defined in `blueprints/groups.yaml` and enforced by application policies in Authentik.

## MFA

TOTP (Time-based One-Time Password) is supported for all users. For members of `superbox-admins`, TOTP enrollment is enforced on first login via the flow defined in `blueprints/flows.yaml`.

Users enroll via the Authentik self-service portal: `https://auth.${DOMAIN}/if/user/`.

Supported authenticator apps: Google Authenticator, Authy, 1Password, Bitwarden, any TOTP-compatible app.

## User Management

### Create a user

1. Authentik admin UI → **Directory → Users → Create**
2. Set username, email, password
3. Add to `superbox-users` or `superbox-admins` group

### Reset a password

```bash
docker exec authentik-server ak set_password --username <user> --password <newpass>
```

### List users via CLI

```bash
docker exec authentik-server ak shell -c "from authentik.core.models import User; print(list(User.objects.values('username', 'email')))"
```

## Environment Variables

| Variable | Generated by | Purpose |
|----------|-------------|---------|
| `AUTHENTIK_SECRET_KEY` | `setup.sh` | Signing key for cookies and tokens — never change after first boot |
| `AUTHENTIK_BOOTSTRAP_PASSWORD` | `setup.sh` | Initial admin password (used on first boot only) |
| `AUTHENTIK_BOOTSTRAP_EMAIL` | `.env` | Admin account email |
| `POSTGRES_PASSWORD` | `setup.sh` | Authentik database password |

## Troubleshooting

**Blueprints not applying:**
```bash
docker compose logs authentik-worker | grep blueprint
```

**Login redirect loop:**
Check that `AUTHENTIK_HOST` in `compose.yml` matches your actual domain. Ensure the outpost router in Traefik is reachable at `https://auth.${DOMAIN}/outpost.goauthentik.io/`.

**Database connection errors:**
```bash
docker compose logs authentik-db
docker exec authentik-db pg_isready -U authentik
```
