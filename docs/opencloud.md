# OpenCloud

The OpenCloud module provides file sync and sharing, CalDAV (calendar), CardDAV (contacts), and real-time collaborative document editing via Collabora Online.

**Location:** `services/opencloud/`

## Components

| Container | Image | Role |
|-----------|-------|------|
| `opencloud` | `opencloudeu/opencloud:rolling` | File sync/share, CalDAV, CardDAV, spaces |
| `collabora` | `collabora/code:24.04` | Real-time document/spreadsheet editing (WOPI) |
| `tika` | `apache/tika:2.9` | Full-text extraction for search indexing |

All three containers share `opencloud-net` for internal communication. Only `opencloud` and `collabora` are exposed via Traefik.

## URLs

| URL | Service |
|-----|---------|
| `https://cloud.${DOMAIN}` | OpenCloud web interface |
| `https://collabora.${DOMAIN}` | Collabora Online (called by OpenCloud — not accessed directly) |

## OpenCloud

OpenCloud EU is a fork of ownCloud Infinite Scale (OCIS), providing a modern file sync/share platform with S3-compatible storage, real-time notifications, and full CalDAV/CardDAV support.

### Authentication

OpenCloud is configured to use Authentik as its OIDC provider:

```env
PROXY_OIDC_ISSUER=https://auth.${DOMAIN}/application/o/opencloud/
WEB_OIDC_CLIENT_ID=opencloud
```

Users log in via Authentik SSO. The `opencloud` Authentik application must be configured in `blueprints/applications.yaml`.

### Storage

All files are stored in `data/opencloud/`. The default storage driver is POSIX filesystem. For production, consider configuring an S3-compatible backend (MinIO, Backblaze B2, AWS S3) via OpenCloud's storage provider settings.

### Spaces

OpenCloud uses a "Spaces" model:

- **Personal space** — each user's private files
- **Project spaces** — shared workspaces for teams (created by admins)
- **Share links** — public or password-protected sharing

### CalDAV / CardDAV

Connect clients using:

| Protocol | URL |
|----------|-----|
| CalDAV | `https://cloud.${DOMAIN}/remote.php/dav/calendars/<username>/` |
| CardDAV | `https://cloud.${DOMAIN}/remote.php/dav/addressbooks/users/<username>/` |

Compatible clients: Thunderbird (with CardBook/Lightning), Apple Calendar/Contacts, DAVx⁵ (Android), GNOME Calendar/Contacts.

### Desktop sync client

Download the OpenCloud desktop client (or the ownCloud client, which is compatible) from [opencloud.eu](https://opencloud.eu). Connect to `https://cloud.${DOMAIN}` and authenticate via Authentik.

### Mobile apps

The ownCloud mobile apps (iOS and Android) work with OpenCloud. Connect to `https://cloud.${DOMAIN}`.

## Collabora Online

Collabora Online provides real-time collaborative editing of Writer (`.docx`, `.odt`), Calc (`.xlsx`, `.ods`), and Impress (`.pptx`, `.odp`) files directly in the OpenCloud web interface.

### Integration

OpenCloud and Collabora communicate via the **WOPI protocol**:

1. User opens a document in OpenCloud
2. OpenCloud generates a WOPI access token and redirects to Collabora
3. Collabora fetches the document from OpenCloud via the WOPI API
4. User edits in the Collabora editor (iframe in OpenCloud)
5. Collabora writes changes back via WOPI on save

The WOPI connection is internal (over `opencloud-net`) — Collabora never exposes the document externally.

### Supported formats

| Category | Formats |
|----------|---------|
| Documents | `.docx`, `.odt`, `.doc`, `.rtf`, `.txt` |
| Spreadsheets | `.xlsx`, `.ods`, `.xls`, `.csv` |
| Presentations | `.pptx`, `.odp`, `.ppt` |

### Admin console

Collabora has an admin console at `https://collabora.${DOMAIN}/browser/dist/admin/admin.html`. Credentials are set via `username` and `password` in `compose.yml` (uses `OC_ADMIN_PASSWORD`).

## Apache Tika

Tika extracts text from documents (PDF, Word, Excel, etc.) for OpenCloud's full-text search indexing. It runs as an internal service on `opencloud-net` with no external exposure.

Supported extraction formats include: PDF, Office documents, HTML, plain text, images (OCR if configured), and many more.

## Environment Variables

| Variable | Purpose |
|----------|---------|
| `OC_DOMAIN` | Public domain for OpenCloud (e.g. `cloud.yourdomain.com`) |
| `OC_ADMIN_USER` | Initial admin username |
| `OC_ADMIN_PASSWORD` | Initial admin password (generated by `setup.sh`) |
| `COLLABORA_DOMAIN` | Collabora's public domain |

## Troubleshooting

**Collabora editor doesn't load:**
- Check that `aliasgroup1` in the Collabora environment matches `https://cloud.${DOMAIN}:443`
- Verify `collabora.${DOMAIN}` resolves and Traefik is routing to port 9980

**CalDAV sync failing:**
- Ensure the CalDAV URL ends with a trailing slash
- Test with `curl -u username https://cloud.${DOMAIN}/remote.php/dav/`

**Search not indexing:**
- Check Tika is running: `docker compose ps tika`
- Verify OpenCloud is configured to use the Tika endpoint
